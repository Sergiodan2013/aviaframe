# ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Supabase - –ó–∞–≤–µ—Ä—à–µ–Ω–∞

**–î–∞—Ç–∞:** 2026-01-26
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç

---

## üéØ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Å—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –§–∞–π–ª: [schema.sql](schema.sql)
- –¢–∞–±–ª–∏—Ü—ã: organizations, users, roles, searches, bookings, drct_request_logs, audit_logs
- –ò–Ω–¥–µ–∫—Å—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã, RLS –ø–æ–ª–∏—Ç–∏–∫–∏
- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### 2. ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –¥–µ–º–æ-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
- **–ù–∞–∑–≤–∞–Ω–∏–µ:** Aviaframe Demo
- **ID:** `59e46b8a-2e65-4cc2-8b51-d60ba46f18bd`
- **–°—Ç—Ä–∞–Ω–∞:** UAE (AE)
- **–í–∞–ª—é—Ç–∞:** AED
- **–°—Ç–∞—Ç—É—Å:** active

### 3. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω Supabase –∫–ª–∏–µ–Ω—Ç
- –§–∞–π–ª: [backend/src/lib/supabase.js](../src/lib/supabase.js)
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### 4. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω —ç–Ω–¥–ø–æ–∏–Ω—Ç –ø–æ–∏—Å–∫–∞
- **–ü—É—Ç—å:** `POST /public/search`
- **–§—É–Ω–∫—Ü–∏—è:** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞–∂–¥—ã–π –ø–æ–∏—Å–∫ –≤ —Ç–∞–±–ª–∏—Ü—É `searches`
- **–î–∞–Ω–Ω—ã–µ:** origin, destination, dates, passengers, cabin_class, duration
- **Tenant ID:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `DEMO_TENANT_ID` –∏–∑ .env

### 5. ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞
- –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001
- –í—ã–ø–æ–ª–Ω–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: DXB ‚Üí LHR
- –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ Supabase
- –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å–∫—Ä–∏–ø—Ç `check_searches.js` –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö

---

## üìù –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

```bash
# Supabase
SUPABASE_URL=https://kirvqjgyxjyvwflghchw.supabase.co
SUPABASE_ANON_KEY=sb_secret_aHEyNslHywW8PqVstY5Fig_5dOkJA-F

# Demo Tenant
DEMO_TENANT_ID=59e46b8a-2e65-4cc2-8b51-d60ba46f18bd
```

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

```bash
cd ~/projects/aviaframe/backend
npm start
# –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ http://localhost:3000
```

### –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫

```bash
curl -X POST http://localhost:3000/public/search \
  -H "Content-Type: application/json" \
  -d '{
    "origin": "DXB",
    "destination": "LHR",
    "depart_date": "2026-03-15",
    "return_date": "2026-03-22",
    "adults": 2,
    "cabin_class": "economy"
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–µ–π –≤ –ë–î

```bash
cd ~/projects/aviaframe/backend
node db/check_searches.js
```

---

## üõ†Ô∏è –ü–æ–ª–µ–∑–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

### 1. create_demo_org.js
–°–æ–∑–¥–∞–µ—Ç –¥–µ–º–æ-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –≤ Supabase:
```bash
node backend/db/create_demo_org.js
```

### 2. check_searches.js
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –ø–æ–∏—Å–∫–æ–≤ –∏–∑ –±–∞–∑—ã:
```bash
node backend/db/check_searches.js
```

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞: searches

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | Primary key |
| tenant_id | UUID | –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è (FK) |
| user_id | UUID | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (nullable) |
| origin | VARCHAR(3) | IATA –∫–æ–¥ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
| destination | VARCHAR(3) | IATA –∫–æ–¥ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞ –ø—Ä–∏–±—ã—Ç–∏—è |
| depart_date | DATE | –î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞ |
| return_date | DATE | –î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (nullable) |
| adults | INT | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∑—Ä–æ—Å–ª—ã—Ö |
| children | INT | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π |
| infants | INT | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–ª–∞–¥–µ–Ω—Ü–µ–≤ |
| cabin_class | VARCHAR(20) | –ö–ª–∞—Å—Å –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è |
| offers_count | INT | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π |
| search_duration_ms | INT | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ (–º—Å) |
| source | VARCHAR(50) | –ò—Å—Ç–æ—á–Ω–∏–∫: api, portal, widget |
| metadata | JSONB | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |
| created_at | TIMESTAMPTZ | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è |

---

## üîç –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î

### –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–æ–∏—Å–∫–∏ –¥–ª—è –¥–µ–º–æ-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

```javascript
const { data, error } = await supabase
  .from('searches')
  .select('*')
  .eq('tenant_id', '59e46b8a-2e65-4cc2-8b51-d60ba46f18bd')
  .order('created_at', { ascending: false });
```

### –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–∏—Å–∫–æ–≤

```sql
SELECT
  origin,
  destination,
  COUNT(*) as search_count,
  AVG(search_duration_ms) as avg_duration
FROM searches
WHERE tenant_id = '59e46b8a-2e65-4cc2-8b51-d60ba46f18bd'
GROUP BY origin, destination
ORDER BY search_count DESC;
```

### –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```sql
SELECT
  origin || ' ‚Üí ' || destination as route,
  COUNT(*) as searches,
  AVG(adults) as avg_passengers
FROM searches
WHERE tenant_id = '59e46b8a-2e65-4cc2-8b51-d60ba46f18bd'
  AND created_at >= NOW() - INTERVAL '30 days'
GROUP BY origin, destination
ORDER BY searches DESC
LIMIT 10;
```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ–º–æ-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
```
‚úÖ PASSED
–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è "Aviaframe Demo" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞
ID: 59e46b8a-2e65-4cc2-8b51-d60ba46f18bd
```

### –¢–µ—Å—Ç 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –≤ –ë–î
```
‚úÖ PASSED
–ó–∞–ø—Ä–æ—Å: POST /public/search
–û—Ç–≤–µ—Ç: { "saved_to_db": true, "search_id": "e206fe0a-..." }
```

### –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Supabase
```
‚úÖ PASSED
–ù–∞–π–¥–µ–Ω–∞ 1 –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ searches
Route: DXB ‚Üí LHR
Passengers: 2 adults
Date: 2026-03-15 - 2026-03-22
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ Supabase credentials –≤ .env (–Ω–µ –∫–æ–º–º–∏—Ç—è—Ç—Å—è –≤ git)
- ‚úÖ Row Level Security (RLS) –≤–∫–ª—é—á–µ–Ω –Ω–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
- ‚úÖ Tenant isolation —á–µ—Ä–µ–∑ tenant_id
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (origin, destination –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã)
- ‚úÖ Error handling (–ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –ë–î)

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ì–æ—Ç–æ–≤–æ ‚úÖ
- [x] –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- [x] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Supabase –∫–ª–∏–µ–Ω—Ç
- [x] –°–æ–∑–¥–∞—Ç—å –¥–µ–º–æ-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é
- [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å /public/search —Å –ë–î
- [x] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É

### –í –ø–ª–∞–Ω–∞—Ö üìã
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –°–æ–∑–¥–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è bookings (–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ DRCT –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å audit trail
- [ ] –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π DRCT API

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [Schema README](README.md) - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Å—Ö–µ–º–µ –ë–î
- [schema.sql](schema.sql) - SQL —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü
- [seed.sql](seed.sql) - –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
- [Supabase Dashboard](https://supabase.com/dashboard/project/kirvqjgyxjyvwflghchw)

---

**–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞:** ‚úÖ Backend –≥–æ—Ç–æ–≤ –∫ –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
**–û–∫—Ä—É–∂–µ–Ω–∏–µ:** Development
**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** Supabase PostgreSQL
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2026-01-26

# Aviaframe Database Schema

–≠—Ç–∞ –ø–∞–ø–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç SQL-—Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Aviaframe –≤ Supabase (PostgreSQL).

## üìã –§–∞–π–ª—ã

- `schema.sql` ‚Äî –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏, –∏–Ω–¥–µ–∫—Å–∞–º–∏, —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏ –∏ RLS –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏
- `seed.sql` ‚Äî –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (–∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ)

1. **organizations** ‚Äî –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏/–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ (B2B –∫–ª–∏–µ–Ω—Ç—ã)
   - –ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (multi-tenant)
   - –°—Ç–∞—Ç—É—Å—ã: active, suspended, deleted
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è: `created_at`, `updated_at`

2. **searches** ‚Äî –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–æ–≤ –±–∏–ª–µ—Ç–æ–≤
   - –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (`tenant_id`)
   - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞: origin, destination, dates, passengers
   - –ú–µ—Ç—Ä–∏–∫–∏: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞
   - –¢–æ–ª—å–∫–æ `created_at` (immutable logs)

3. **bookings** ‚Äî –ó–∞–∫–∞–∑—ã/–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
   - –°—Ç–∞—Ç—É—Å—ã: PENDING, BOOKED, ISSUED, CANCELLED, FAILED, RECONCILE
   - –¶–µ–Ω—ã: `NUMERIC(10,2)` –¥–ª—è —Ç–æ—á–Ω—ã—Ö –¥–µ–Ω–µ–∂–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
   - –î–∞—Ç—ã: `TIMESTAMPTZ` —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏
   - –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ: `passenger_data` (JSONB) –¥–ª—è PII
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è: `created_at`, `updated_at`, `issued_at`, `cancelled_at`

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (–¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã)

4. **users** ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∞–≥–µ–Ω—Ç—Å—Ç–≤ (–∞–≥–µ–Ω—Ç—ã, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã)
   - –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
   - –†–æ–ª–∏ —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É `roles`
   - Email —É–Ω–∏–∫–∞–ª–µ–Ω –≤ —Ä–∞–º–∫–∞—Ö tenant

5. **roles** ‚Äî –†–æ–ª–∏ –¥–ª—è RBAC
   - –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ: platform_admin, agency_admin, agent
   - –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ JSONB

6. **drct_request_logs** ‚Äî –õ–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ DRCT API
   - Append-only (—Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ)
   - –°–∞–Ω–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–±–µ–∑ —Å—ã—Ä–æ–≥–æ PII)
   - –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

7. **audit_logs** ‚Äî –ê—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - Immutable (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–π)
   - –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ IP –∞–¥—Ä–µ—Å–∞
   - –î–ª—è compliance –∏ —Ñ–æ—Ä–µ–Ω–∑–∏–∫–∏

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –≤ Supabase

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Supabase Dashboard (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–∫—Ä–æ–π—Ç–µ [Supabase Dashboard](https://supabase.com/dashboard)
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç: `kirvqjgyxjyvwflghchw`
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
4. –ù–∞–∂–º–∏—Ç–µ **New Query**
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `schema.sql`
6. –ù–∞–∂–º–∏—Ç–µ **Run** –∏–ª–∏ `Cmd+Enter`

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ psql (–∫–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞)

```bash
# –ü–æ–ª—É—á–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–∑ Supabase Dashboard ‚Üí Settings ‚Üí Database
psql "postgresql://postgres:[YOUR-PASSWORD]@db.kirvqjgyxjyvwflghchw.supabase.co:5432/postgres" -f backend/db/schema.sql
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ Node.js —Å–∫—Ä–∏–ø—Ç

```javascript
const supabase = require('./src/lib/supabase');
const fs = require('fs');

const schema = fs.readFileSync('./db/schema.sql', 'utf8');

// –í—ã–ø–æ–ª–Ω–∏—Ç—å —á–µ—Ä–µ–∑ Supabase SQL
// (—Ç—Ä–µ–±—É–µ—Ç admin –¥–æ—Å—Ç—É–ø)
```

## üîê Row Level Security (RLS)

–°—Ö–µ–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ RLS –¥–ª—è –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö:

- **Tenant Isolation**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ —Å–≤–æ–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `SET app.current_tenant_id = 'uuid'` –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ tenant context

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è RLS

```sql
-- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π tenant (–≤ –≤–∞—à–µ–º middleware)
SET app.current_tenant_id = 'your-tenant-uuid-here';

-- –¢–µ–ø–µ—Ä—å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ tenant_id
SELECT * FROM bookings; -- –í–µ—Ä–Ω–µ—Ç —Ç–æ–ª—å–∫–æ bookings –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ tenant
```

## üìä –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

### –î–µ–Ω–µ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- **–¢–∏–ø**: `NUMERIC(10, 2)`
- **–ü—Ä–∏–º–µ—Ä**: `1234.56` (–¥–æ 8 —Ü–∏—Ñ—Ä –¥–æ –∑–∞–ø—è—Ç–æ–π, 2 –ø–æ—Å–ª–µ)
- **–ü–æ—á–µ–º—É**: –¢–æ—á–Ω–æ—Å—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç FLOAT)

### –î–∞—Ç—ã –∏ –≤—Ä–µ–º—è
- **–¢–∏–ø**: `TIMESTAMPTZ`
- **–§–æ—Ä–º–∞—Ç**: ISO 8601 —Å —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–æ–º
- **–ü—Ä–∏–º–µ—Ä**: `2026-01-26T15:30:00+00:00`
- **–ü–æ—á–µ–º—É**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤

### UUID
- **–¢–∏–ø**: `UUID`
- **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è**: `uuid_generate_v4()`
- **–ü—Ä–∏–º–µ—Ä**: `550e8400-e29b-41d4-a716-446655440000`

### JSONB
- **–¢–∏–ø**: `JSONB` (–±–∏–Ω–∞—Ä–Ω—ã–π JSON —Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π)
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: metadata, permissions, fare_breakdown, passenger_data
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**: –ì–∏–±–∫–æ—Å—Ç—å + –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤

## üîç –ò–Ω–¥–µ–∫—Å—ã

–°—Ö–µ–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:

- **tenant_id**: –ù–∞ –≤—Å–µ—Ö tenant-scoped —Ç–∞–±–ª–∏—Ü–∞—Ö (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è multi-tenancy)
- **created_at**: –î–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–∞—Ç–µ (DESC –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π)
- **status**: –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
- **Foreign keys**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ FK

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã

### updated_at
–¢–∞–±–ª–∏—Ü—ã —Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `updated_at`:
- organizations
- roles
- users
- bookings

```sql
-- –¢—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç updated_at –ø—Ä–∏ UPDATE
UPDATE bookings SET status = 'ISSUED' WHERE id = '...';
-- updated_at –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ NOW()
```

## üìà –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Views)

### booking_stats_by_org
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (booked, issued, cancelled)
- –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–∞–ª—é—Ç–∞–º

```sql
SELECT * FROM booking_stats_by_org WHERE organization_id = 'your-uuid';
```

### search_stats_by_org
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∏—Å–∫–æ–≤ –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º:
- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–æ–≤
- –ü–æ–∏—Å–∫–∏ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
- –°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞
- –ü–æ –¥–Ω—è–º

```sql
SELECT * FROM search_stats_by_org
WHERE organization_id = 'your-uuid'
  AND search_date >= CURRENT_DATE - INTERVAL '30 days';
```

## üß™ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã, –≤ –±–∞–∑–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:
- **Name**: Test Travel Agency
- **Legal Name**: Test Travel Agency LLC
- **Country**: AE (UAE)
- **Currency**: AED
- **Status**: active

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å PII

### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤

–í —Ç–∞–±–ª–∏—Ü–µ `bookings`:
- `passenger_data` ‚Äî JSONB —Å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤
- `contact_email` ‚Äî –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π email
- `contact_phone` ‚Äî –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω

### –õ–æ–≥–∏ –±–µ–∑ PII
- `drct_request_logs` ‚Äî —Ç–æ–ª—å–∫–æ —Å–∞–Ω–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- `audit_logs` ‚Äî –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ IP –∞–¥—Ä–µ—Å–∞ –∏ PII

## üìù –ú–∏–≥—Ä–∞—Ü–∏–∏

–î–ª—è –±—É–¥—É—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:

```bash
# –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
mkdir -p backend/db/migrations
touch backend/db/migrations/001_add_column_xyz.sql
```

## üÜò Troubleshooting

### –û—à–∏–±–∫–∞: "extension uuid-ossp does not exist"
```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```
–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å –ø—Ä–∞–≤–∞–º–∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≤ Supabase Dashboard.

### –û—à–∏–±–∫–∞: RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
–í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```sql
ALTER TABLE bookings DISABLE ROW LEVEL SECURITY;
```

### –°–±—Ä–æ—Å —Å—Ö–µ–º—ã (–í–ù–ò–ú–ê–ù–ò–ï: –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!)
```sql
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
-- –ó–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω–∏—Ç—å schema.sql –∑–∞–Ω–æ–≤–æ
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Supabase Documentation](https://supabase.com/docs)
- [PostgreSQL Data Types](https://www.postgresql.org/docs/current/datatype.html)
- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
- [Aviaframe Data Model](../docs/05_DATA_MODEL.md)

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2026-01-26

{
  "name": "DRCT Search Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "drct/search",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "b8c0c7e8-8f3a-4e5a-9e1a-1e8f9c7a3e1a",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300],
      "webhookId": "drct-search"
    },
    {
      "parameters": {
        "jsCode": "// Transform Aviaframe format to DRCT API format\nconst body = $input.item.json.body;\n\nif (!body) {\n  throw new Error('Request body is required');\n}\n\n// Validate required fields\nif (!body.origin || !body.destination || !body.depart_date) {\n  throw new Error('origin, destination, and depart_date are required');\n}\n\n// Ensure date format is YYYY-MM-DD\nfunction formatDate(dateStr) {\n  if (!dateStr) return null;\n  // If already in YYYY-MM-DD format, return as is\n  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(dateStr)) {\n    return dateStr;\n  }\n  // Try to parse and format\n  const date = new Date(dateStr);\n  if (isNaN(date.getTime())) {\n    throw new Error(`Invalid date format: ${dateStr}`);\n  }\n  return date.toISOString().split('T')[0];\n}\n\n// Build flights array\nconst flights = [];\n\n// Outbound flight\nflights.push({\n  departure_airport_code: body.origin.toUpperCase(),\n  arrival_airport_code: body.destination.toUpperCase(),\n  departure_date: formatDate(body.depart_date)\n});\n\n// Return flight (if provided)\nif (body.return_date) {\n  flights.push({\n    departure_airport_code: body.destination.toUpperCase(),\n    arrival_airport_code: body.origin.toUpperCase(),\n    departure_date: formatDate(body.return_date)\n  });\n}\n\n// Build passengers array\nconst passengers = [];\n\n// Add adults (default to 1 if not provided)\nconst adults = body.adults || 1;\nfor (let i = 0; i < adults; i++) {\n  passengers.push({ type: \"ADT\" });\n}\n\n// Add children\nconst children = body.children || 0;\nfor (let i = 0; i < children; i++) {\n  passengers.push({ type: \"CHD\" });\n}\n\n// Add infants\nconst infants = body.infants || 0;\nfor (let i = 0; i < infants; i++) {\n  passengers.push({ type: \"INF\" });\n}\n\n// Build DRCT request\nconst drctRequest = {\n  flights: flights,\n  passengers: passengers\n};\n\n// Add filters if cabin_class is provided\nif (body.cabin_class) {\n  drctRequest.filters = {\n    cabin_class: body.cabin_class.toLowerCase()\n  };\n}\n\nconsole.log('[Transform] Converted to DRCT format:', JSON.stringify(drctRequest, null, 2));\n\nreturn drctRequest;"
      },
      "id": "a0b1c2d3-4e5f-6a7b-8c9d-0e1f2a3b4c5d",
      "name": "Transform to DRCT Format",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [470, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://sandbox-api.drct.aero/offers_search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "DRCT-Version",
              "value": "2021-06-01"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json",
              "neverError": true
            }
          },
          "timeout": 30000
        }
      },
      "id": "a1b2c3d4-5e6f-7a8b-9c0d-1e2f3a4b5c6d",
      "name": "DRCT Search API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [690, 300]
    },
    {
      "parameters": {
        "jsCode": "// Transform DRCT API response to Aviaframe format\nconst response = $input.item.json;\n\nconsole.log('[Transform] DRCT response received');\nconsole.log('[Transform] Response keys:', Object.keys(response));\nconsole.log('[Transform] Full response:', JSON.stringify(response, null, 2));\n\n// DRCT API returns different structures - check what we have\nlet offers = [];\n\n// Option 1: response.data.offers (nested)\nif (response.data && response.data.offers) {\n  offers = response.data.offers;\n  console.log('[Transform] Found offers in response.data.offers');\n}\n// Option 2: response.offers (direct)\nelse if (response.offers) {\n  offers = response.offers;\n  console.log('[Transform] Found offers in response.offers');\n}\n// Option 3: response itself is an array\nelse if (Array.isArray(response)) {\n  offers = response;\n  console.log('[Transform] Response is an array');\n}\n// Option 4: response.data is an array\nelse if (response.data && Array.isArray(response.data)) {\n  offers = response.data;\n  console.log('[Transform] Found offers in response.data array');\n}\nelse {\n  console.log('[Transform] WARNING: Could not find offers in response');\n  console.log('[Transform] Available keys:', Object.keys(response));\n  // Return the whole response for debugging\n  return response;\n}\n\nconsole.log(`[Transform] Processing ${offers.length} offers`);\n\n// Transform each offer to Aviaframe format\nconst transformedOffers = offers.map(offer => ({\n  offer_id: offer.id || offer.offer_id,\n  origin: offer.origin || offer.departure_airport || 'N/A',\n  destination: offer.destination || offer.arrival_airport || 'N/A',\n  departure_time: offer.departure_time || offer.departure || 'N/A',\n  arrival_time: offer.arrival_time || offer.arrival || 'N/A',\n  airline_code: offer.airline_code || offer.carrier || offer.airline || 'N/A',\n  airline_name: offer.airline_name || offer.carrier_name || 'Unknown',\n  flight_number: offer.flight_number || 'N/A',\n  price: {\n    total: offer.price?.total || offer.total_price || 0,\n    currency: offer.price?.currency || offer.currency || 'USD',\n    base: offer.price?.base || 0,\n    taxes: offer.price?.taxes || 0\n  },\n  duration: offer.duration || 'N/A',\n  stops: offer.stops || 0,\n  baggage: offer.baggage || {},\n  cabin_class: offer.cabin_class || offer.fare_family || 'ECONOMY',\n  available_seats: offer.available_seats || 0,\n  segments: offer.segments || [],\n  _raw: offer\n}));\n\nconsole.log('[Transform] Transformed offers:', transformedOffers.length);\n\nreturn {\n  search_id: response.search_id || response.id || 'unknown',\n  offers: transformedOffers,\n  metadata: {\n    total_offers: transformedOffers.length,\n    timestamp: new Date().toISOString(),\n    api_version: response.api_version || '1.0'\n  }\n};"
      },
      "id": "c5d6e7f8-9a0b-1c2d-3e4f-5a6b7c8d9e0f",
      "name": "Transform Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [910, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "responseCode": 200
        }
      },
      "id": "d7e8f9a0-1b2c-3d4e-5f6a-7b8c9d0e1f2a",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1130, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n  error: {\n    code: 'DRCT_API_ERROR',\n    message: 'Failed to fetch search results from DRCT API',\n    details: $json.error || $json.message || 'Unknown error'\n  }\n}) }}",
        "options": {
          "responseCode": 500
        }
      },
      "id": "f9a0b1c2-3d4e-5f6a-7b8c-9d0e1f2a3b4c",
      "name": "Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [690, 480]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Transform to DRCT Format",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform to DRCT Format": {
      "main": [
        [
          {
            "node": "DRCT Search API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DRCT Search API": {
      "main": [
        [
          {
            "node": "Transform Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2026-01-27T00:00:00.000Z",
      "updatedAt": "2026-01-27T00:00:00.000Z",
      "id": "1",
      "name": "DRCT"
    },
    {
      "createdAt": "2026-01-27T00:00:00.000Z",
      "updatedAt": "2026-01-27T00:00:00.000Z",
      "id": "2",
      "name": "Search"
    }
  ],
  "meta": {
    "instanceId": "local"
  },
  "pinData": {},
  "versionId": "2",
  "triggerCount": 0,
  "active": false
}

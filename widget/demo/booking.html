<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aviaframe Booking</title>
  <style>
    body { margin: 0; padding: 24px; background: #e9effb; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; color: #111827; }
    .wrap { max-width: 860px; margin: 0 auto; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 18px; padding: 28px; box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08); }
    .center { text-align: center; }
    .ok { font-size: 62px; color: #f97316; line-height: 1; }
    .title { font-size: 52px; font-weight: 800; margin: 8px 0 8px; }
    .subtitle { font-size: 32px; color: #4b5563; margin-bottom: 18px; }
    .number { border: 1px solid #f3c58c; background: #fff7ed; border-radius: 12px; padding: 16px; text-align: center; font-size: 32px; font-weight: 700; color: #92400e; margin-bottom: 14px; }
    .status { border: 1px solid #fde68a; background: #fffbeb; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .status h3 { margin: 0 0 8px; font-size: 32px; color: #92400e; text-align: center; }
    .status p { margin: 0; font-size: 20px; color: #92400e; text-align: center; }
    .details { border: 1px solid #e5e7eb; background: #f9fafb; border-radius: 12px; padding: 16px; }
    .details h4 { margin: 0 0 12px; font-size: 28px; }
    .grid { display: grid; grid-template-columns: 1fr auto; gap: 8px; font-size: 20px; color: #374151; }
    .val { font-weight: 700; }
    .due { border-top: 1px solid #d1d5db; margin-top: 8px; padding-top: 8px; }
    .duev { border-top: 1px solid #d1d5db; margin-top: 8px; padding-top: 8px; font-size: 34px; font-weight: 800; color: #ea580c; }
    .loading { font-size: 22px; color: #4b5563; text-align: center; padding: 24px; }
    .error { border: 1px solid #fecaca; background: #fff1f2; color: #b91c1c; border-radius: 12px; padding: 14px; font-size: 18px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="booking-root">
      <div class="loading">Creating booking...</div>
    </div>
  </div>

  <script>
    (async function () {
      const root = document.getElementById('booking-root');

      const selectedOfferRaw = localStorage.getItem('selectedOffer');
      const passengerRaw = localStorage.getItem('passengerData');

      if (!selectedOfferRaw || !passengerRaw) {
        root.innerHTML = '<div class="error">No booking data found. Return to search and select a flight again.</div>';
        return;
      }

      let selectedOffer;
      let passenger;
      try {
        selectedOffer = JSON.parse(selectedOfferRaw);
        passenger = JSON.parse(passengerRaw);
      } catch {
        root.innerHTML = '<div class="error">Failed to read booking data from localStorage.</div>';
        return;
      }

      const userRaw = localStorage.getItem('user');
      let currentUser = null;
      try {
        currentUser = userRaw ? JSON.parse(userRaw) : null;
      } catch {
        currentUser = null;
      }

      const baggagePrices = {
        none: 0,
        '20kg': 500,
        '30kg': 750
      };
      const baggageValue = passenger.baggage || 'none';
      const baggagePrice = baggagePrices[baggageValue] || 0;
      const nationality = passenger.nationality || 'SA';
      const basePrice = (selectedOffer.price || {}).total || 0;
      const totalPrice = basePrice + baggagePrice;
      const currency = (selectedOffer.price || {}).currency || 'UAH';

      const payload = {
        offer_id: selectedOffer.offer_id,
        passengers: [{
          type: 'ADT',
          first_name: passenger.firstName,
          last_name: passenger.lastName,
          date_of_birth: passenger.dateOfBirth,
          gender: passenger.gender === 'male' ? 'M' : 'F',
          document: {
            type: 'passport',
            number: passenger.passportNumber,
            expiry_date: passenger.passportExpiry,
            issuing_country: nationality
          }
        }],
        contacts: {
          email: passenger.email,
          phone: passenger.phone
        },
        user_id: currentUser?.id || null,
        user_email: currentUser?.email || passenger.email || null,
        offer: {
          origin: selectedOffer.origin,
          destination: selectedOffer.destination,
          departure_time: selectedOffer.departure_time,
          arrival_time: selectedOffer.arrival_time,
          airline_code: selectedOffer.airline_code,
          airline_name: selectedOffer.airline_name,
          flight_number: selectedOffer.flight_number,
          base_price: basePrice,
          taxes: (selectedOffer.price || {}).taxes || 0,
          currency
        },
        passenger_details: {
          passport_number: passenger.passportNumber,
          passport_expiry: passenger.passportExpiry,
          baggage_allowance: baggageValue,
          nationality
        },
        pricing: {
          base_price: basePrice,
          taxes: (selectedOffer.price || {}).taxes || 0,
          baggage_price: baggagePrice,
          total_price: totalPrice,
          currency
        },
        raw_offer_data: selectedOffer
      };

      console.log('Creating Hold Booking via n8n webhook with passenger data:', passenger);
      console.log('Sending complete order to n8n webhook:', payload);

      let responseData = null;
      let lastError = null;
      const idempotencyKey = `wgt_${Date.now()}_${Math.random().toString(36).slice(2, 10)}`;
      const requestOptions = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Idempotency-Key': idempotencyKey
        },
        body: JSON.stringify(payload)
      };

      try {
        const primaryUrl = '/api/n8n/webhook-test/drct/order/create';
        let resp = await fetch(primaryUrl, requestOptions);

        if (!resp.ok && resp.status === 404) {
          const fallbackUrl = '/api/n8n/webhook/drct/order/create';
          resp = await fetch(fallbackUrl, requestOptions);
          if (!resp.ok) {
            let fallbackBody = '';
            try {
              fallbackBody = await resp.text();
            } catch {
              fallbackBody = '';
            }
            lastError = `HTTP ${resp.status} on ${fallbackUrl}${fallbackBody ? `: ${fallbackBody.slice(0, 220)}` : ''}`;
          } else {
            responseData = await resp.json().catch(() => ({}));
          }
        } else if (!resp.ok) {
          let bodyText = '';
          try {
            bodyText = await resp.text();
          } catch {
            bodyText = '';
          }
          lastError = `HTTP ${resp.status} on ${primaryUrl}${bodyText ? `: ${bodyText.slice(0, 220)}` : ''}`;
        } else {
          responseData = await resp.json().catch(() => ({}));
        }
      } catch (e) {
        lastError = String(e && e.message ? e.message : e);
      }

      if (!responseData) {
        root.innerHTML = `<div class="error">Failed to create booking.\n${lastError || 'Unknown error'}\nCheck webhook drct/order/create and /api/* proxy.</div>`;
        return;
      }

      console.log('Order created successfully via n8n:', responseData);

      const orderNumber = responseData.order_number || responseData.booking_reference || responseData.drct_order_id || '—';
      const total = Math.round(totalPrice).toLocaleString('en-US');
      const departure = String(selectedOffer.departure_time || '').slice(0, 16).replace('T', ' ');

      root.innerHTML = `
        <div class="center ok">✓</div>
        <div class="center title">Booking created!</div>
        <div class="center subtitle">Flight is booked and awaiting payment.</div>
        <div class="number">Booking number: ${orderNumber}</div>
        <div class="status">
          <h3>Status: Awaiting payment</h3>
          <p>Complete payment to finalize booking. Instructions were sent to ${passenger.email}.</p>
        </div>
        <div class="details">
          <h4>Flight details</h4>
          <div class="grid">
            <div>Route:</div><div class="val">${selectedOffer.origin || '---'} → ${selectedOffer.destination || '---'}</div>
            <div>Airline:</div><div class="val">${selectedOffer.airline_name || selectedOffer.airline_code || 'N/A'}</div>
            <div>Departure:</div><div class="val">${departure}</div>
            <div>Passenger:</div><div class="val">${passenger.firstName} ${passenger.lastName}</div>
            <div class="due">Amount due:</div><div class="duev">${total} ${currency}</div>
          </div>
        </div>
      `;
    })();
  </script>
</body>
</html>

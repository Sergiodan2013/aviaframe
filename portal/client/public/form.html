<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aviaframe - Поиск и бронирование авиабилетов</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Custom styles for embedded widget */
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    /* Loader animation */
    @keyframes plane-fly {
      0% { transform: translateX(-100px) rotate(45deg); opacity: 0; }
      50% { opacity: 1; }
      100% { transform: translateX(400px) rotate(45deg); opacity: 0; }
    }

    .plane-loader {
      animation: plane-fly 2s ease-in-out infinite;
    }

    /* Smooth transitions */
    .aviaframe-card {
      transition: all 0.3s ease;
    }

    .aviaframe-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

  <!-- Main Container -->
  <div id="aviaframe-widget" class="container mx-auto px-4 py-8 max-w-6xl">

    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Aviaframe</h1>
            <p class="text-sm text-gray-600">Поиск и бронирование авиабилетов</p>
          </div>
        </div>
        <div id="agency-logo" class="text-sm text-gray-500">
          <!-- Agency logo will be injected here -->
        </div>
      </div>
    </div>

    <!-- Search Form -->
    <div id="search-section" class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Найти рейс</h2>

      <form id="search-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Origin -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Откуда</label>
          <input
            type="text"
            id="origin"
            placeholder="MAD"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            required
            maxlength="3"
          />
        </div>

        <!-- Destination -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Куда</label>
          <input
            type="text"
            id="destination"
            placeholder="ATH"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            required
            maxlength="3"
          />
        </div>

        <!-- Depart Date -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Дата вылета</label>
          <input
            type="date"
            id="depart_date"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            required
          />
        </div>

        <!-- Return Date -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Дата возврата</label>
          <input
            type="date"
            id="return_date"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>

        <!-- Adults -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Взрослых</label>
          <select
            id="adults"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="1" selected>1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </div>

        <!-- Cabin Class -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Класс</label>
          <select
            id="cabin_class"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="economy" selected>Эконом</option>
            <option value="premium_economy">Премиум эконом</option>
            <option value="business">Бизнес</option>
            <option value="first">Первый</option>
          </select>
        </div>

        <!-- Search Button -->
        <div class="md:col-span-2 flex items-end">
          <button
            type="submit"
            id="search-btn"
            class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-md hover:shadow-lg"
          >
            Найти рейсы
          </button>
        </div>
      </form>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="hidden bg-white rounded-lg shadow-md p-12 mb-6">
      <div class="flex flex-col items-center justify-center">
        <div class="relative w-full h-20 mb-4 overflow-hidden">
          <svg class="plane-loader w-12 h-12 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
            <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
          </svg>
        </div>
        <p class="text-gray-600 text-lg font-medium">Ищем лучшие рейсы...</p>
      </div>
    </div>

    <!-- Error Message -->
    <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
      <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <div>
          <h3 class="text-red-800 font-semibold">Ошибка</h3>
          <p id="error-text" class="text-red-700 text-sm mt-1"></p>
        </div>
      </div>
    </div>

    <!-- Results Container -->
    <div id="results-section" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-4 mb-4">
        <h2 class="text-xl font-semibold text-gray-800">Результаты поиска</h2>
        <p id="results-count" class="text-gray-600 text-sm mt-1"></p>
      </div>

      <div id="flights-list" class="space-y-4">
        <!-- Flight cards will be injected here -->
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden bg-white rounded-lg shadow-md p-12 text-center">
      <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="currentColor" viewBox="0 0 24 24">
        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
      </svg>
      <h3 class="text-xl font-semibold text-gray-700 mb-2">Рейсов не найдено</h3>
      <p class="text-gray-500">Попробуйте изменить параметры поиска</p>
    </div>

  </div>

  <!-- Configuration Script -->
  <script>
    // Widget Configuration
    const AVIAFRAME_CONFIG = {
      // API endpoints
      apiBaseUrl: window.AVIAFRAME_API_URL || 'https://benedictory-tyrannous-norris.ngrok-free.dev',
      searchEndpoint: '/webhook-test/drct/search',
      priceEndpoint: '/webhook-test/drct/price',
      orderEndpoint: '/webhook-test/drct/order/create',

      // Agency settings (can be overridden via URL params or script attributes)
      agencyId: new URLSearchParams(window.location.search).get('agency_id') || 'default',
      agencyName: new URLSearchParams(window.location.search).get('agency_name') || '',
      agencyLogo: new URLSearchParams(window.location.search).get('agency_logo') || '',

      // UI settings
      primaryColor: '#3B82F6', // blue-500
      accentColor: '#6366F1',  // indigo-500

      // Feature flags
      showLogo: true,
      enableAnalytics: false,
    };

    // Set minimum date for date pickers (tomorrow)
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const minDate = tomorrow.toISOString().split('T')[0];
    document.getElementById('depart_date').min = minDate;
    document.getElementById('return_date').min = minDate;

    // Set default depart date to tomorrow
    document.getElementById('depart_date').value = minDate;

    // Show agency logo if provided
    if (AVIAFRAME_CONFIG.agencyName) {
      document.getElementById('agency-logo').innerHTML = `
        ${AVIAFRAME_CONFIG.agencyLogo ? `<img src="${AVIAFRAME_CONFIG.agencyLogo}" alt="${AVIAFRAME_CONFIG.agencyName}" class="h-8">` : ''}
        <span class="font-medium">${AVIAFRAME_CONFIG.agencyName}</span>
      `;
    }

    // Search Form Handler
    document.getElementById('search-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = {
        origin: document.getElementById('origin').value.toUpperCase(),
        destination: document.getElementById('destination').value.toUpperCase(),
        depart_date: document.getElementById('depart_date').value,
        return_date: document.getElementById('return_date').value || null,
        adults: parseInt(document.getElementById('adults').value),
        cabin_class: document.getElementById('cabin_class').value,
        agency_id: AVIAFRAME_CONFIG.agencyId
      };

      console.log('Search initiated:', formData);

      // Show loading
      showLoading();
      hideError();
      hideResults();

      try {
        const response = await fetch(
          `${AVIAFRAME_CONFIG.apiBaseUrl}${AVIAFRAME_CONFIG.searchEndpoint}`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'ngrok-skip-browser-warning': 'true'
            },
            body: JSON.stringify(formData)
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('Search results:', data);

        hideLoading();

        // Handle results
        if (data.offers && data.offers.length > 0) {
          displayResults(data.offers);
        } else {
          showEmptyState();
        }

      } catch (error) {
        console.error('Search error:', error);
        hideLoading();
        showError(`Не удалось выполнить поиск: ${error.message}`);
      }
    });

    // Display Results
    function displayResults(offers) {
      const resultsSection = document.getElementById('results-section');
      const flightsList = document.getElementById('flights-list');
      const resultsCount = document.getElementById('results-count');

      resultsCount.textContent = `Найдено рейсов: ${offers.length}`;
      flightsList.innerHTML = '';

      offers.forEach((offer, index) => {
        const flightCard = createFlightCard(offer, index);
        flightsList.appendChild(flightCard);
      });

      resultsSection.classList.remove('hidden');

      // Smooth scroll to results
      resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Create Flight Card
    function createFlightCard(offer, index) {
      const card = document.createElement('div');
      card.className = 'aviaframe-card bg-white rounded-lg shadow-md p-6 border border-gray-200';

      const price = offer.price?.total || offer.total_price || 0;
      const currency = offer.price?.currency || offer.currency || 'UAH';

      card.innerHTML = `
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <!-- Flight Info -->
          <div class="flex-1">
            <div class="flex items-center gap-3 mb-3">
              <div class="bg-blue-50 px-3 py-1 rounded-full">
                <span class="text-sm font-semibold text-blue-700">${offer.airline_code || offer.airline || 'N/A'}</span>
              </div>
              <span class="text-sm text-gray-500">${offer.flight_number || ''}</span>
            </div>

            <div class="flex items-center gap-6 mb-2">
              <div class="text-center">
                <div class="text-2xl font-bold text-gray-900">${offer.origin || 'N/A'}</div>
                <div class="text-sm text-gray-500">${formatTime(offer.departure_time)}</div>
              </div>

              <div class="flex-1 flex items-center">
                <div class="flex-1 h-px bg-gray-300"></div>
                <svg class="w-6 h-6 text-gray-400 mx-2" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                </svg>
                <div class="flex-1 h-px bg-gray-300"></div>
              </div>

              <div class="text-center">
                <div class="text-2xl font-bold text-gray-900">${offer.destination || 'N/A'}</div>
                <div class="text-sm text-gray-500">${formatTime(offer.arrival_time)}</div>
              </div>
            </div>

            <div class="text-sm text-gray-600">
              ${offer.airline_name || offer.airline_code || 'Unknown Airline'}
            </div>
          </div>

          <!-- Price and Action -->
          <div class="flex flex-col items-end gap-3 lg:w-48">
            <div class="text-right">
              <div class="text-3xl font-bold text-blue-600">${Math.round(price)} ${currency}</div>
              <div class="text-sm text-gray-500">за взрослого</div>
            </div>
            <button
              onclick="selectFlight(${index})"
              class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-md hover:shadow-lg"
            >
              Выбрать
            </button>
          </div>
        </div>
      `;

      return card;
    }

    // Select Flight Handler
    let selectedOffer = null;

    window.selectFlight = function(index) {
      const offers = window.currentOffers || [];
      selectedOffer = offers[index];

      console.log('Flight selected:', selectedOffer);

      // In a real implementation, this would:
      // 1. Navigate to passenger form (either new page or modal)
      // 2. Or send postMessage to parent window if embedded in iframe
      // 3. Or redirect to booking page with offer_id

      // For now, show alert with offer ID
      alert(`Рейс выбран!\n\nOffer ID: ${selectedOffer.offer_id || selectedOffer.id}\n\nДалее откроется форма пассажира для завершения бронирования.`);

      // If embedded in iframe, send message to parent
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'AVIAFRAME_FLIGHT_SELECTED',
          offer: selectedOffer
        }, '*');
      } else {
        // Redirect to main app with offer data
        const offerData = encodeURIComponent(JSON.stringify(selectedOffer));
        window.location.href = `http://localhost:3002?offer=${offerData}`;
      }
    };

    // Utility Functions
    function formatTime(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      } catch {
        return dateString;
      }
    }

    function showLoading() {
      document.getElementById('loading-screen').classList.remove('hidden');
      document.getElementById('search-btn').disabled = true;
      document.getElementById('search-btn').textContent = 'Поиск...';
    }

    function hideLoading() {
      document.getElementById('loading-screen').classList.add('hidden');
      document.getElementById('search-btn').disabled = false;
      document.getElementById('search-btn').textContent = 'Найти рейсы';
    }

    function showError(message) {
      document.getElementById('error-message').classList.remove('hidden');
      document.getElementById('error-text').textContent = message;
    }

    function hideError() {
      document.getElementById('error-message').classList.add('hidden');
    }

    function showEmptyState() {
      document.getElementById('empty-state').classList.remove('hidden');
    }

    function hideResults() {
      document.getElementById('results-section').classList.add('hidden');
      document.getElementById('empty-state').classList.add('hidden');
    }

    // Store offers globally for selectFlight function
    window.currentOffers = [];

    const originalDisplayResults = displayResults;
    displayResults = function(offers) {
      window.currentOffers = offers;
      originalDisplayResults(offers);
    };

    console.log('Aviaframe Widget initialized', AVIAFRAME_CONFIG);
  </script>

</body>
</html>
